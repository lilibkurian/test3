---
# ============================
# RG Tag enforcement
# ============================
- name: Get resource group info
  azure.azcollection.azure_rm_resourcegroup_info:
    name: "{{ target.resource_group }}"
  register: rg_info

- name: Fail if resource group not found
  ansible.builtin.fail:
    msg: "Resource group '{{ target.resource_group }}' not found"
  when: (rg_info.resourcegroups | default([]) | length) == 0

- name: Set RG facts
  ansible.builtin.set_fact:
    rg_location: "{{ rg_info.resourcegroups[0].location }}"
    rg_tags_current: "{{ rg_info.resourcegroups[0].tags | default({}, true) }}"

- name: Ensure RG tag business-internalorder=wl-to-azure-2026 (merge)
  azure.azcollection.azure_rm_resourcegroup:
    name: "{{ target.resource_group }}"
    location: "{{ rg_location }}"
    tags: "{{ rg_tags_current | combine(required_rg_tags, recursive=True) }}"
  when: (rg_tags_current.get('business-internalorder', '') != required_rg_tags['business-internalorder'])

# ============================
# VM Tag enforcement
# ============================
- name: Get VM facts (for tagging)
  azure.azcollection.azure_rm_virtualmachine_info:
    resource_group: "{{ target.resource_group }}"
    name: "{{ target.vm_name }}"
  register: vm_info

- name: Skip if VM not found
  ansible.builtin.debug:
    msg: "SKIP TAGS: VM '{{ target.vm_name }}' not found in RG '{{ target.resource_group }}'"
  when: (vm_info.vms | default([]) | length) == 0

- name: Set VM tag facts
  ansible.builtin.set_fact:
    vm_tags_current: "{{ vm_info.vms[0].tags | default({}, true) }}"
    vm_backup_tag_value: "{{ 'cloudstandardfs' if (target.vm_name | lower) is search('sql') else 'cloudstandard' }}"
  when: (vm_info.vms | default([]) | length) > 0

- name: Ensure VM tag backuptype (merge)
  azure.azcollection.azure_rm_virtualmachine:
    resource_group: "{{ target.resource_group }}"
    name: "{{ target.vm_name }}"
    tags: "{{ vm_tags_current | combine({'backuptype': vm_backup_tag_value}, recursive=True) }}"
  when:
    - (vm_info.vms | default([]) | length) > 0
    - (vm_tags_current.get('backuptype', '') != vm_backup_tag_value)

- name: Show tag results
  ansible.builtin.debug:
    msg:
      - "VM: {{ target.vm_name }} (RG: {{ target.resource_group }})"
      - "RG tag ensured: business-internalorder={{ required_rg_tags['business-internalorder'] }}"
      - "VM tag ensured: backuptype={{ vm_backup_tag_value }}"
  when: (vm_info.vms | default([]) | length) > 0