---
- name: Verify Environment Variables
  fail:
    msg: "Environment variables DOMAIN_USER or DOMAIN_PASSWORD are not set."
  run_once: true
  delegate_to: localhost
  when:
    - lookup('env', 'DOMAIN_USER') == "" or lookup('env', 'DOMAIN_PASSWORD') == ""

# --------------------------------------------------------------------------
# 1. SEARCH: Loop through vCenters to find where this VM lives
# --------------------------------------------------------------------------
- name: Search for VM in vCenters
  community.vmware.vmware_guest_info:
    hostname: "{{ item }}"
    username: "{{ lookup('env', 'DOMAIN_USER') }}"
    password: "{{ lookup('env', 'DOMAIN_PASSWORD') }}"
    validate_certs: false
    name: "{{ inventory_hostname }}"
  loop: "{{ vcenters_list }}"
  register: vm_search_results
  ignore_errors: true
  delegate_to: localhost
  # This makes it run quietly until it finds the right one
  #no_log: true

- name: Identify correct vCenter
  set_fact:
    target_vcenter: "{{ item.item }}"
    vm_is_found: true
  loop: "{{ vm_search_results.results }}"
  when:
    - item is succeeded
    - item.instance is defined
  no_log: true

# --------------------------------------------------------------------------
# 2. ACTION: Power Off and Rename (Only if VM was found)
# --------------------------------------------------------------------------
- name: Power Off VM (Force)
  community.vmware.vmware_guest_powerstate:
    hostname: "{{ target_vcenter }}"
    username: "{{ lookup('env', 'DOMAIN_USER') }}"
    password: "{{ lookup('env', 'DOMAIN_PASSWORD') }}"
    validate_certs: false
    name: "{{ inventory_hostname }}"
    state: powered-off
  delegate_to: localhost
  register: poweroff_result
  when: vm_is_found is defined

- name: Rename VM
  community.vmware.vmware_object_rename:
    hostname: "{{ target_vcenter }}"
    username: "{{ lookup('env', 'DOMAIN_USER') }}"
    password: "{{ lookup('env', 'DOMAIN_PASSWORD') }}"
    validate_certs: false
    name: "{{ inventory_hostname }}"
    new_name: "_DoNotPowerOn-{{ inventory_hostname }}"
    object_type: VirtualMachine
  delegate_to: localhost
  register: rename_result
  when: 
    - vm_is_found is defined
    - poweroff_result is succeeded

# --------------------------------------------------------------------------
# FINAL DECOMMISSION SUMMARY
# --------------------------------------------------------------------------
- name: Final Decommission Summary
  run_once: true
  delegate_to: localhost
  debug:
    msg: "{{ summary_table.split('\n') | select('ne', '') | list }}"
  vars:
    summary_table: |
      ---------------------------------------------------------------------------------------------------------------------------
      {{ '%-20s | %-25s | %-60s' | format('VM NAME', 'STATUS', 'RESULT MESSAGE') }}
      ---------------------------------------------------------------------------------------------------------------------------

      {% for host in ansible_play_hosts -%}
      
      {# --- Retrieve Variables for specific host --- #}
      {%- set is_found = hostvars[host]['vm_is_found'] | default(false) -%}
      {%- set p_res = hostvars[host]['poweroff_result'] | default({}) -%}
      {%- set r_res = hostvars[host]['rename_result'] | default({}) -%}
      {%- set found_vc = hostvars[host]['target_vcenter'] | default('None') -%}

      {# --- LOGIC TO DETERMINE STATUS --- #}
      {%- if not is_found -%}
          {%- set status = 'Not Found' -%}
          {%- set msg_raw = 'VM not found in any of the 10 vCenters' -%}
      
      {%- elif p_res.failed | default(false) -%}
          {%- set status = 'PowerOff Failed' -%}
          {%- set msg_raw = p_res.msg | default('Unknown PowerOff Error') -%}

      {%- elif r_res.failed | default(false) -%}
          {%- set status = 'Rename Failed' -%}
          {%- set msg_raw = r_res.msg | default('Unknown Rename Error') -%}

      {%- else -%}
          {%- set status = 'Success' -%}
          {%- if p_res.changed and r_res.changed -%}
             {%- set msg_raw = 'Powered Off & Renamed on ' ~ found_vc -%}
          {%- elif r_res.changed -%}
             {%- set msg_raw = 'Already Off, Renamed on ' ~ found_vc -%}
          {%- else -%}
             {%- set msg_raw = 'Already Off & Renamed on ' ~ found_vc -%}
          {%- endif -%}
      {%- endif -%}

      {{ '%-20s | %-25s | %-60s' | format(host, status, msg_raw | truncate(60)) }}
      {% endfor -%}
      ---------------------------------------------------------------------------------------------------------------------------