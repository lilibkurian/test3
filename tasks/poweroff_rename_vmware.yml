---
- name: Verify Environment Variables
  fail:
    msg: "Environment variables DOMAIN_USER or DOMAIN_PASSWORD are not set."
  run_once: true
  delegate_to: localhost
  when:
    - lookup('env', 'DOMAIN_USER') == "" or lookup('env', 'DOMAIN_PASSWORD') == ""

- name: Run PowerCLI script
  command: >
    pwsh -File "{{ script_path }}"
    -VMName "{{ inventory_hostname }}"
    -User "{{ lookup('env', 'DOMAIN_USER') }}"
    -Password "{{ lookup('env', 'DOMAIN_PASSWORD') }}"
    -LogPath "{{ playbook_dir }}/scripts/logs/PowerOff_{{ inventory_hostname }}.log"
  delegate_to: localhost
  register: script_output
  #no_log: true
  # Retry logic to handle vCenter timeouts (Request channel timed out)
  retries: 3
  delay: 10
  until: script_output.rc == 0 or (script_output.stdout | regex_search("VM .* not found"))
  # Define "Change" vs "Failure"
  changed_when:
    - "'Successfully renamed' in script_output.stdout"
  failed_when:
    - script_output.rc != 0
    # The regex below matches "VM", followed by any characters (.*), followed by "not found"
    - not script_output.stdout | regex_search("VM .* not found")
  # Keep this to prevent one hard failure (like auth error) from stopping the whole playbook
  ignore_errors: true

# --------------------------------------------------------------------------
# FINAL DECOMMISSION SUMMARY
# --------------------------------------------------------------------------
- name: Final Decommission Summary
  run_once: true
  delegate_to: localhost
  debug:
    msg: "{{ summary_table.split('\n') | select('ne', '') | list }}"
  vars:
    summary_table: |
      ---------------------------------------------------------------------------------------------------------------------------
      {{ '%-20s | %-25s | %-60s' | format('VM NAME', 'STATUS', 'RESULT MESSAGE') }}
      ---------------------------------------------------------------------------------------------------------------------------

      {% for host in ansible_play_hosts -%}
      {%- set host_result = hostvars[host]['script_output'] -%}

      {# --- LOGIC TO DETERMINE STATUS AND MESSAGE --- #}

      {# 1. FAILED CASE #}
      {%- if host_result.failed is defined and host_result.failed -%}
        {%- set status = 'FAILED' -%}
        {%- set raw_line = host_result.stdout_lines[-1] | default(host_result.msg) | default('Unknown Error') -%}
        {%- set msg_raw = raw_line.split('] ')[-1] | default(raw_line) -%}

      {# 2. CHANGED CASE (Action Taken) #}
      {%- elif host_result.changed -%}
        {%- if 'VM is already Powered OFF' in (host_result.stdout | default('')) -%}
            {%- set status = 'Renamed (Was Off)' -%}
        {%- else -%}
            {%- set status = 'Powered Off & Renamed' -%}
        {%- endif -%}

        {%- set raw_line = host_result.stdout_lines[-1] | default('') -%}
        {%- set msg_raw = raw_line.split('] ')[-1] | default(raw_line) -%}

      {# 3. SKIPPED/OK CASE (Already Done or Not Found) #}
      {%- else -%}
        {%- if host_result.stdout is defined and (host_result.stdout | regex_search("VM .* not found")) -%}
           {%- set status = 'Not Found' -%}
        {%- else -%}
           {%- set status = 'Already Done' -%}
        {%- endif -%}
        {%- set raw_line = host_result.stdout_lines[-1] | default('No output') -%}
        {%- set msg_raw = raw_line.split('] ')[-1] | default(raw_line) -%}
      {%- endif -%}

      {{ '%-20s | %-25s | %-60s' | format(host, status, msg_raw | truncate(60)) }}
      {% endfor -%}
      ---------------------------------------------------------------------------------------------------------------------------